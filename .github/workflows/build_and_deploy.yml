name: Build and Deploy
on:
  workflow_dispatch:
  push: 
    branches: [ main ]
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # „É¨„Éù„Ç∏„Éà„É™„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ„Ç¢„Ç¶„Éà
      - name: Check out the repo
        uses: actions/checkout@v4
      # dockerx„Çí‰ΩøÁî®ÂèØËÉΩ„Å´„Åô„Çã
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      # github packages„Å´„É≠„Ç∞„Ç§„É≥
      - name: Login GitHub Packages
        uses: docker/login-action@v1
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      # „É¶„Éº„Ç∂„ÉºÂêç„Å´Â§ßÊñáÂ≠ó„ÅåÂê´„Åæ„Çå„ÇãÂ†¥Âêà„Å´ÂÇô„Åà„Å¶Â∞èÊñáÂ≠ó„Å´Â§âÊèõ„Åô„Çã
      - name: Convert to lowercase
        id: lowercase
        run: echo "::set-output name=actor::$(echo "${{ github.actor }}" | tr '[:upper:]' '[:lower:]')"
      # „Éó„É≠„Ç∏„Çß„ÇØ„Éà„É´„Éº„Éà„ÅÆDockerfile„Çí„Éì„É´„Éâ„Åó„Å¶„ÄÅghcr.io/username/guild-mng-bot:latest„Å®„Åó„Å¶ÂÖ¨Èñã„Åô„Çã
      - name: build for bot
        uses: docker/build-push-action@v2
        with:
          context: .
          push: true
          tags: ghcr.io/${{ steps.lowercase.outputs.actor }}/guild-mng-bot:latest
      # Webhook„ÇíÈÄÅ‰ø°„Åô„Çã
      - name: Send Webhook to Portainer
        run: |
          curl -X POST -H "Content-Type: application/json" -d '{"repository": "${{ github.repository }}", "branch": "${{ github.ref }}", "commit": "${{ github.sha }}", "actor": "${{ github.actor }}", "workflow": "${{ github.workflow }}"}' ${{ secrets.PORTAINER_WEBHOOK_URL }}

  notify-discord:
    runs-on: ubuntu-latest
    steps:
      # Discord„Å´ÈÄöÁü•„Åô„Çã
      - name: Notify Discord
        run: |
          # Embed„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆÂÜÖÂÆπ„Çí‰ΩúÊàê
          if [ ${{ job.status }} == "success" ]; then
            echo "EMBED_TITLE=‚úÖ„Éá„Éó„É≠„Ç§„Å´ÊàêÂäü„Åó„Åæ„Åó„Åü" >> $GITHUB_ENV
            echo "EMBED_COLOR=5763719" >> $GITHUB_ENV
          else
            echo "EMBED_TITLE=üö´„Éá„Éó„É≠„Ç§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü" >> $GITHUB_ENV
            echo "EMBED_COLOR=15548997" >> $GITHUB_ENV
          fi
          PORTAINER_URL="https://portainer.worldcell.yagloud.com/#!/home"
          REPO_URL="https://github.com/${{ github.repository }}"
          DEPLOY_WORKFLOW_URL=$REPO_URL/actions/runs/${{ github.run_id }}
          PAYLOAD='{
            "content": "„ÉÜ„Çπ„Éà:",
            "embeds": [
              {
                "title": "'${{ env.EMBED_TITLE }}'",
                "description": "[„Éá„Éó„É≠„Ç§ÂÖà]('${PORTAINER_URL}')\n[„É™„Éù„Ç∏„Éà„É™]('${REPO_URL}')\n[„ÉØ„Éº„ÇØ„Éï„É≠„Éº]('${DEPLOY_WORKFLOW_URL}')",
                "color": '${{ env.EMBED_COLOR }}'
              }
            ]
          }'

          # Webhook„Å´POST„É™„ÇØ„Ç®„Çπ„Éà„ÇíÈÄÅ‰ø°
          curl -X POST -H "Content-Type: application/json" -d "$PAYLOAD" "${{ secrets.DISCORD_WEBHOOK_URL }}"